<div class="admin-dashboard-container">
  <!-- Header -->
  <header class="dashboard-header" *ngIf="!isEmbedded">
    <div class="header-content">
      <div class="header-title">
        <h1>🎛️ Administration du Dashboard</h1>
        <p>Interface de gestion et modification du tableau de bord Metabase</p>
      </div>
      <div class="header-actions">
        <button class="btn-back" (click)="goBack()">← Retour</button>
        <button class="btn-logout" (click)="logout()">Déconnexion</button>
      </div>
    </div>
  </header>

  <!-- Admin Controls Bar -->
  <section class="admin-controls" *ngIf="!isEmbedded">
    <div class="controls-content">
      <div class="control-group">
        <h3>Outils d'Administration</h3>
        <div class="control-buttons">
          <button class="control-btn edit" (click)="openMetabaseEditor()">
            ✏️ Éditer dans Metabase
          </button>
          <button class="control-btn refresh" (click)="refreshData()">
            🔄 Actualiser
          </button>
          <button class="control-btn config" (click)="openDashboardConfig()">
            ⚙️ Configuration
          </button>
          <button class="control-btn export" (click)="exportDashboard()">
            📤 Exporter
          </button>
          <button class="control-btn users" (click)="scrollToUserManagement()">
            👥 Utilisateurs
          </button>
        </div>
      </div>

      <div class="control-group">
        <h3>Statut du Dashboard</h3>
        <div class="status-indicators">
          <div class="status-item">
            <span class="status-dot" [class.active]="isMetabaseConnected"></span>
            <span>Metabase: {{ isMetabaseConnected ? 'Connecté' : 'Déconnecté' }}</span>
          </div>
          <div class="status-item">
            <span class="status-dot active"></span>
            <span>Dashboard: Actif</span>
          </div>
          <div class="status-item">
            <span class="status-dot" [class.warning]="hasPendingChanges"></span>
            <span>Modifications: {{ hasPendingChanges ? 'En attente' : 'Synchronisées' }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Preview -->
  <section class="dashboard-preview" *ngIf="!isEmbedded">
    <div class="preview-header">
      <h2>Aperçu du Dashboard</h2>
      <div class="preview-actions">
        <button class="btn-fullscreen" (click)="toggleFullscreen()">
          {{ isFullscreen ? '⛶ Quitter plein écran' : '⛶ Plein écran' }}
        </button>
      </div>
    </div>

    <div class="preview-content" [class.fullscreen]="isFullscreen">
      <div class="metabase-container" *ngIf="selectedDashboard">
        <iframe
          [src]="getSafeUrl()"
          width="100%"
          height="700"
          frameborder="0"
          allowtransparency="true"
          allowfullscreen
          (load)="onIframeLoad()"
          (error)="onIframeError()">
        </iframe>

        <!-- Error Overlay -->
        <div class="metabase-error" *ngIf="metabaseError">
          <div class="error-content">
            <div class="error-icon">🎛️</div>
            <h3>Dashboard Metabase</h3>
            <p>Pour des raisons de sécurité, l'édition s'effectue dans un nouvel onglet.</p>
            <div class="metabase-info">
              <h4>🛠️ Fonctionnalités d'administration :</h4>
              <ul>
                <li>👥 Gestion complète des utilisateurs</li>
                <li>📤 Export PDF et partage sécurisé</li>
                <li>⚙️ Configuration et maintenance</li>
                <li>🔧 Contrôle du système</li>
              </ul>
            </div>
            <div class="error-actions">
              <button class="btn-primary" (click)="openMetabaseEditor()">✏️ Éditer dans Metabase</button>
              <button class="btn-export" (click)="openExportModal()">📤 Exporter & Partager</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="loading-spinner"></div>
        <p>Chargement du dashboard...</p>
      </div>
    </div>
  </section>

  <!-- Dashboard Management -->
  <section class="dashboard-management" *ngIf="!isEmbedded">
    <div class="management-content">
      <div class="management-card">
        <h3>📊 Informations du Dashboard</h3>
        <div class="info-grid" *ngIf="selectedDashboard">
          <div class="info-item">
            <label>Nom:</label>
            <span>{{ selectedDashboard.name }}</span>
          </div>
          <div class="info-item">
            <label>ID:</label>
            <span>{{ selectedDashboard.id }}</span>
          </div>
          <div class="info-item">
            <label>Catégorie:</label>
            <span>{{ selectedDashboard.category }}</span>
          </div>
          <div class="info-item">
            <label>Statut:</label>
            <span class="status-badge" [class.active]="selectedDashboard.isActive">
              {{ selectedDashboard.isActive ? 'Actif' : 'Inactif' }}
            </span>
          </div>
          <div class="info-item">
            <label>URL Metabase:</label>
            <span class="url-text">{{ selectedDashboard.url }}</span>
          </div>
          <div class="info-item">
            <label>Dernière modification:</label>
            <span>{{ getLastModified() }}</span>
          </div>
        </div>
      </div>

      <div class="management-card">
        <h3>🔧 Actions de Maintenance</h3>
        <div class="maintenance-actions">
          <button class="maintenance-btn" (click)="backupDashboard()">
            💾 Sauvegarder
          </button>
          <button class="maintenance-btn" (click)="resetDashboard()">
            🔄 Réinitialiser
          </button>
          <button class="maintenance-btn warning" (click)="clearCache()">
            🗑️ Vider le cache
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- User Management -->
  <section class="user-management">
    <div class="management-content">
      <div class="management-card">
        <div class="user-management-header">
          <h3>👥 Gestion des Utilisateurs</h3>
          <button class="btn-add-user" (click)="showAddUserForm = !showAddUserForm">
            {{ showAddUserForm ? '❌ Annuler' : '➕ Ajouter un utilisateur' }}
          </button>
        </div>

        <!-- Add User Form -->
        <div class="add-user-form" *ngIf="showAddUserForm">
          <h4>Nouvel Utilisateur</h4>
          <form (ngSubmit)="addUser(newUser)" class="user-form">
            <div class="form-row">
              <div class="form-group">
                <label>Nom complet:</label>
                <input type="text" [(ngModel)]="newUser.name" name="name" required>
              </div>
              <div class="form-group">
                <label>Email:</label>
                <input type="email" [(ngModel)]="newUser.email" name="email" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Rôle:</label>
                <select [(ngModel)]="newUser.role" name="role" required>
                  <option value="USER">Utilisateur</option>
                  <option value="ADMIN">Administrateur</option>
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">💾 Créer l'utilisateur</button>
            </div>
          </form>
        </div>

        <!-- Users List -->
        <div class="users-list">
          <h4>Utilisateurs existants ({{ users.length }})</h4>
          <div class="users-table">
            <div class="table-header">
              <div class="table-cell">Nom</div>
              <div class="table-cell">Email</div>
              <div class="table-cell">Rôle</div>
              <div class="table-cell">Créé le</div>
              <div class="table-cell">Dernière connexion</div>
              <div class="table-cell">Actions</div>
            </div>
            <div class="table-body">
              <div class="table-row" *ngFor="let user of users">
                <div class="table-cell">{{ user.name }}</div>
                <div class="table-cell">{{ user.email }}</div>
                <div class="table-cell">
                  <span class="role-badge" [class.admin]="user.role === 'ADMIN'">
                    {{ user.role === 'ADMIN' ? 'Admin' : 'User' }}
                  </span>
                </div>
                <div class="table-cell">{{ user.createdAt ? (user.createdAt | date:'dd/MM/yyyy HH:mm') : 'N/A' }}</div>
                <div class="table-cell">{{ user.lastLogin ? (user.lastLogin | date:'dd/MM/yyyy HH:mm') : 'Jamais' }}</div>
                <div class="table-cell">
                  <button class="btn-delete" (click)="deleteUser(user.id!)" title="Supprimer">
                    🗑️
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Export Modal -->
  <app-export-modal
    [isVisible]="showExportModal"
    [dashboardId]="selectedDashboard?.id || null"
    [dashboardName]="selectedDashboard?.name || ''"
    (closeModal)="closeExportModal()">
  </app-export-modal>
</div>
